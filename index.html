import React, {useCallback, useEffect, useState} from "react";
import Menu from "../src/components/Panel/inc/Menu";
import BreadCrumb from "../src/components/Admin/BreadCrumb";
import Http             from "@/src/services/http";

import '../src/formats';
import {useRouter} from 'next/router';
import {NextPageContext} from "next";
import getStaticPropsHandler from "../src/utils/admin/getStaticPropsHandler";
import moment from "moment";
import userService from "@/src/services/user";
import 'moment/locale/tr';
import SweetAlert from "react-bootstrap-sweetalert";
import Toast from "@/src/utils/toast";
import { Button, Col, Form, Modal, Row } from 'react-bootstrap';
import DatePicker, {registerLocale} from "react-datepicker";
import "react-datepicker/dist/react-datepicker.css";
import {ChangeEvent}       from "@/node_modules/@types/react";
import el                  from "date-fns/locale/tr";
// @ts-ignore
import download            from 'downloadjs';
import {isMobile}          from "react-device-detect";
import { RPagination }     from "@/src/components/Pagination";
import Loader              from '@/src/assets/gifs/loader.svg';
import { ScrollToTop }     from "@/src/components/ScrollToTop";
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome'
import { faFile }          from '@fortawesome/free-solid-svg-icons'
import { api_url }         from "@/src/utils/api";
import isImage from '@/src/utils/isImage';

registerLocale("el", el);

moment.locale('tr');

type TabloData = {
    status: boolean,
    data: TabloRowData[],
    totalItems: number;
    totalPages: number;
    currentPage: number;
    limit: number;
}

type TabloRowData = {
    id: number,
    sira: number,
    talep_tarihi: Date | string | any,
    statu: string,
    sorumlu_id:number
    oncelik_durum: string,
    ekleyen: string,
    kategori: string,
    modul: string,
    ekran: string,
    aciklama: string,
    sorumlu_name: string,
    sistem_yanit: string,
    tamamlanma_tarihi: Date | string | any
    resimler: []
}

type Resimler = {
    id : string | number
    file : string | Blob
    destek_id : number
}

type YeniTabloData = {
    id: number,
    talep_tarihi: Date | string | any,
    statu: string,
    oncelik_durum: string,
    ekleyen_id: number,
    kategori: string,
    modul: string,
    ekran: string,
    aciklama: string
}

type AdminUsers = {
    id: number
    name: string
    surname: string
    type: string
}

type acikTalep = {
    talep_sayisi: number
}

const DestekTalep = ({ globalData }) => {
    const router = useRouter();
    const [loaded, setLoaded] = useState<boolean>(false);
    const [silmeModal, setSilmeModal] = useState<number | string | null>(null);
    const [editModal, setEditModal] = useState<boolean>(false);
    const toast = new Toast();
    const [kayitModal, setKayitModal] = useState<boolean>(false);
    const [orderBy] = useState<string>("created_at");
    const [orderDir] = useState<string>("desc");
    const [ page, setPage ] = useState<number> ( 1 );
    const [searchStatu, setSearchStatu] = useState<string>('');
    const [searchKategori, setSearchKategori] = useState<string>('');
    const [searchEkleyen, setSearchEkleyen] = useState<string>('');
    const [sorumlu, setSorumlu] = useState<string>('');
    const [searchOncelik, setSearchOncelik] = useState<string>('');
    const [topluIds, setTopluIds] = useState<string[]>([])
    const [topluSilmeModal, setTopluSilmeModal] = useState<boolean>(false)
    const [adminUsers, setAdminUsers] = useState<AdminUsers[]>([])
    const [ acikTalepSayisi, setAcikTalepSayisi ] = useState<number> ( 0 );
    const [tabloData, setTabloData] = useState<TabloData>({
        status: false,
        data: [],
        totalItems: 0,
        totalPages :0,
        currentPage : 1,
        limit  :25,
    });
    const [ fileList, setFileList ]     = useState<string[] | Blob[]> ( [] );

    const [yeniTabloData, setYeniTabloData] = useState<YeniTabloData>({
        id: 0,
        talep_tarihi: null,
        statu: "",
        oncelik_durum: "",
        ekleyen_id: 0,
        kategori: "",
        modul: "",
        ekran: "",
        aciklama: "",
    });

    const [rowData, setRowData] = useState<TabloRowData>({
        id: 0,
        sira: 0,
        talep_tarihi: "",
        statu: "",
        oncelik_durum: "",
        ekleyen: "",
        sorumlu_id:0,
        kategori: "",
        sorumlu_name: "",
        modul: "",
        ekran: "",
        aciklama: "",
        sistem_yanit: "",
        tamamlanma_tarihi: "",
        resimler : []
    });


    const filtreTemizle = () => {
        setSearchStatu('');
        setSearchKategori('');
        setSearchEkleyen('');
        setSorumlu('');
        setSearchOncelik('');
    };
    useEffect(() => {
        if (!userService.loggedIn) {
            router.push("/login");
            return;
        }
        if (!userService.hasYetki("destek_talep")) {
            router.push('/main-page');
            return;
        }
        setTimeout(() => {
            setLoaded(true);
        }, 600);

        if (window.localStorage.getItem('api_token')) {

            // fetchTabloData();
            fetchAdminUsers();
        }
    }, []);

    function kayitSil(kayitId: number) {
        Http.post('destekTalep/kayitIptal.php', {
            kayitId: kayitId,
            islem: 'delete'
        }).then(({data}) => {
            if (data.status) {
                toast.success('Kayıt iptal edildi.');
                fetchTabloData()

            } else toast.error('Kayıt iptal edilemedi.');
        });
        setSilmeModal(null);
    }

    const handleYeniTabloData = (
      e: ChangeEvent<HTMLInputElement | HTMLSelectElement>
    ) => {
        if (editModal) {
            setRowData((preS: TabloRowData) => ({
                ...preS,
                [e.target.name]: e.target.value,
            }));
        } else {
            setYeniTabloData((preS: YeniTabloData) => ({
                ...preS,
                [e.target.name]: e.target.value,
            }));
        }
    };
    
    const onFileChange = ( event : any ) =>
    {
        setFileList ( oldArray => [...oldArray, event.target.files[ 0 ]] );
    };

    const kayitModalKapat = () => {
        setEditModal(false);
        setKayitModal(false);
        setYeniTabloData({
            id: 0,
            talep_tarihi: "",
            statu: "",
            oncelik_durum: "",
            ekleyen_id: 0,
            kategori: "",
            modul: "",
            ekran: "",
            aciklama: "",
        });
        setFileList([])
    };

    const fetchTabloData = async () => {
        let searchString: string = '';

        if (searchStatu) {
            searchString += '&statu=' + searchStatu;
        }
        if (searchKategori) {
            searchString += '&kategori=' + searchKategori;
        }
        if (searchEkleyen) {
            searchString += '&ekleyen=' + searchEkleyen;
        }
        if (sorumlu) {
            searchString += '&sorumlu=' + sorumlu;
        }

        if (searchOncelik) {
            searchString += '&oncelik_durum=' + searchOncelik;
        }

        await Http.get(`destekTalep/getData.php?order_by=${orderBy}&order_dir=${orderDir}${searchString}`).then(response => {
            if (response.status) {
                setTabloData(response.data)
                setAcikTalepSayisi(response.data?.acikTalepSayisi)
            } else {
                toast.error("Destek talep listesi çekilirken hata");
            }
        })
    };
    
    const fetchAdminUsers=async ()=>{
        Http.get("/users?type=admin").then(({data})=>{
            setAdminUsers(data)
        });
    }

    const addTopluId = (e: React.ChangeEvent<HTMLInputElement>, itemId: string) => {
        setTopluIds((preS: string[]) => [...preS, itemId])
        if (!e.target.checked) {
            setTopluIds((preS: string[]) => preS.filter((id) => id !== itemId))
        }
    }

    const selectAllCheckbox = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!e.target.checked) {
            setTopluIds([])
        } else {
            const result: string[] = []
            for (let i in tabloData.data) {
                const item = tabloData.data[i]
                result.push(`${item.id}`)
            }
            setTopluIds(result)
        }
    }

    const topluSil = async () => {
        toast.info(`${topluIds.length > 0 ? 'Kayıtlar' : 'Kayıt'} siliniyor`)
        const { data } = await Http.post(`destekTalep/kayitSil.php?`, {
            kayitId: topluIds,
            toplu: true,
        })
        if (data.status) {
            toast.success(`${topluIds.length > 0 ? 'Kayıtlar' : 'Kayıt'} silindi`)
            fetchTabloData()
            setTopluIds([])
            setTopluSilmeModal(false)
        } else {
            toast.error(`${topluIds.length > 0 ? 'Kayıtlar' : 'Kayıt'} silinemedi`)
            setTopluSilmeModal(false)
        }
    }

    useEffect(() => {
        fetchTabloData()
    }, [page, searchStatu, searchKategori,searchOncelik, searchEkleyen, sorumlu, orderBy, orderDir])

    const updateOpenModal = async (rowData: TabloRowData) => {
        setKayitModal(true)
        setEditModal(true)
        setRowData({...rowData})
        console.log (rowData.resimler);
        setFileList(rowData.resimler)
    }
    
    const downloadFileAll = async (fileNames: string[]) => {
        for (let i in fileNames)
        {
            let fileName = fileNames[i]
            fileName = fileName.replace("//","/")
            await Http.get(`downloadFile.php?name=${fileName}`, {
                responseType: 'blob',
            })
                .then((response) => {
                    let blob = new Blob([response.data], {
                        type: 'application/octet-stream',
                    });
                    let url = window.URL.createObjectURL(blob);
                    let link = document.createElement('a');
                    link.href = url;
                    link.download = fileName.slice(8);
                    link.click();
                })
                .catch((error) => {
                    console.log(error);
                });
        }
    }

    const submitTabloData = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
    
        const kayitData = new FormData ();
        kayitData.append("id", yeniTabloData.id !== null ? yeniTabloData.id.toString() : null)
        kayitData.append("talep_tarihi", yeniTabloData.talep_tarihi)
        kayitData.append("statu", 'Bekliyor')
        kayitData.append("oncelik_durum", yeniTabloData.oncelik_durum)
        kayitData.append("ekleyen_id", userService.user.id)
        kayitData.append("kategori", yeniTabloData.kategori)
        kayitData.append("modul", yeniTabloData.modul)
        kayitData.append("ekran", yeniTabloData.ekran)
        kayitData.append("aciklama", yeniTabloData.aciklama)
        
        const updateData = new FormData();
        updateData.append("id", rowData.id !== null ? rowData.id.toString() : null)
        updateData.append("sira", rowData.sira !== null ? rowData.sira.toString() : null)
        updateData.append("talep_tarihi", rowData.talep_tarihi)
        updateData.append("statu", rowData.statu)
        updateData.append("oncelik_durum", rowData.oncelik_durum)
        updateData.append("ekleyen", rowData.ekleyen)
        updateData.append("sorumlu_id", rowData.sorumlu_id !== null ? rowData.sorumlu_id.toString() : null)
        updateData.append("kategori", rowData.kategori)
        updateData.append("sorumlu_name", rowData.sorumlu_name)
        updateData.append("modul", rowData.modul)
        updateData.append("ekran", rowData.ekran)
        updateData.append("aciklama", rowData.aciklama)
        updateData.append("sistem_yanit", rowData.sistem_yanit)
        updateData.append("tamamlanma_tarihi", rowData.tamamlanma_tarihi)
        updateData.append("ekleyen_id", userService.user.id)
        for(let i in fileList)
        {
            kayitData.append ( `fileList[${i}]`, fileList[i] );
            updateData.append ( `fileList[${i}]`, fileList[i] );
        }
        if(!editModal)
        {
            kayitData.append("islem","save")
            updateData.append("islem","save")
        }
        else
        {
            kayitData.append("islem","update")
            updateData.append("islem","update")
        }

        try {
            await Http.post(
              `destekTalep/kayit.php`, (!editModal ? kayitData : updateData)
            ).then(({data}) => {
                if (data.status) {
                    !editModal ? toast.success("Kayıt Eklendi") : toast.success("Güncelleme Başarılı");
                    kayitModalKapat();
                    setTimeout(() => {
                        fetchTabloData();
                    }, 800);
                } else !editModal ? toast.error("Kayıt Eklenemedi") : toast.error("Güncelleme Başarısız");
            });
        } catch (e) {
            console.log(e)
        }
    };
    
    function getName (url){
        try{
            const result = url.split("/")
    
            return result[result.length - 1]
        }catch ( e )
        {
            console.log (e);
            return url;
        }
    }

    var statuBg: {[key: string]: string} = {
        'Tamamlandı': '#1E824C', //87e5b2 //1E824C
        'Bekliyor': '#F5AB35', //ffcf84 //F5AB35
        'İptal': '#FF0000' //ff7575 //FF0000
    }

    var statuColor: {[key: string]: string} = {
        'Tamamlandı': '#fff',
        'Bekliyor': '#fff',
        'İptal': '#fff'
    }

    return <div className="wrapper">
        <style>{globalData.font}</style>
        <style>{globalData.adminCss}</style>
        {loaded ? (
          <div>
              <Menu />

              <div className="content-wrapper fs13">
                  <section className="content-header">
                      <div className="container-fluid">
                          <div className="row mb-2">
                              <div className="col-sm-6"><h1>Destek Talep | Açık Talep: {acikTalepSayisi}</h1></div>
                              <div className="col-sm-6"></div>
                          </div>
                      </div>
                  </section>
                  <div className="content">
                      <div className="row flex-nowrap mb-3">
                          <div className="col-12">
                              <div className="row align-items-center">
                                  <div className="col-md-8 col-sm-12">
                                      <div className="d-flex align-items-center" style={{columnGap:'12px'}}>
                                          <div className='form-group w40'>
                                              <label className='text-nowrap'>Statü</label>
                                              <Form.Select
                                                className='form-control fs-13 text-left align-middle'
                                                value = {searchStatu}
                                                onChange={(e: ChangeEvent<HTMLSelectElement>) => setSearchStatu(e.target.value)}>
                                                  <option value=' '>Seçiniz</option>
                                                  <option value='Bekliyor'>Bekliyor</option>
                                                  <option value='İşleme Alındı'>İşleme Alındı</option>
                                                  <option value='Tamamlandı'>Tamamlandı</option>
                                                  <option value='İptal'>İptal</option>
                                              </Form.Select>
                                          </div>

                                          <div className='form-group w40'>
                                              <label className='text-nowrap'>Kategori</label>
                                              <Form.Select
                                                className='form-control fs-13 text-left align-middle'
                                                value = {searchKategori}
                                                onChange={(e: ChangeEvent<HTMLSelectElement>) =>{
                                                    setSearchKategori(e.target.value);
                                                }
                                                }>
                                                  <option value=' '>Seçiniz</option>
                                                  <option value='Düzeltme'>Düzeltme</option>
                                                  <option value='Geliştirme'>Geliştirme</option>
                                              </Form.Select>
                                          </div>

                                          <div className='form-group w40'>
                                              <label className='text-nowrap'>Öncelik</label>
                                              <Form.Select
                                                className='form-control fs-13 text-left align-middle'
                                                value = {searchOncelik}
                                                onChange={(e: ChangeEvent<HTMLSelectElement>) =>{
                                                    setSearchOncelik(e.target.value);
                                                }
                                                }>
                                                  <option value=''>Seçiniz</option>
                                                  <option value="Düşük">Düşük</option>
                                                  <option value="Normal">Normal</option>
                                                  <option value="Yüksek">Yüksek</option>
                                              </Form.Select>
                                          </div>

                                          <div className='form-group w40'>
                                              <label className='text-nowrap'>Sorumlu</label>

                                              <input
                                                type="text"
                                                className="form-control text-center fs13"
                                                value={sorumlu}
                                                onChange={(e) => setSorumlu(e.target.value)}
                                              />
                                          </div>

                                          <div className='form-group w40'>
                                              <label className='text-nowrap'>Ekleyen</label>

                                              <input
                                                type="text"
                                                className="form-control text-center fs13"
                                                value={searchEkleyen}
                                                onChange={(e) => setSearchEkleyen(e.target.value)}
                                              />
                                          </div>
                                          <div className='form-group mt-3 d-none d-md-block w30'>
                                              <button className='btn form-control btn-default borderless fs13 text-nowrap mt-2' onClick={filtreTemizle}>
                                                  <i className='nav-icon fa fa-trash pt-1' />
                                                  &nbsp; Temizle
                                              </button>
                                          </div>
                                      </div>
                                  </div>
                                  <div className="col-md-4 col-sm-12">
                                      <div className="d-flex align-items-center justify-content-end"  style={{columnGap:'12px'}}>
                                          <div className='form-group d-block d-md-none mt-3 w40'>
                                              <button className='btn form-control btn-default borderless fs13 text-nowrap mt-2' onClick={filtreTemizle}>
                                                  <i className='nav-icon fa fa-trash pt-1' />
                                                  &nbsp; Temizle
                                              </button>
                                          </div>
                                          {topluIds.length > 0 ? (
                                            <div className='filter-btn-holder w40'>
                                                <button
                                                  className={`btn form-control fs13 text-nowrap mt-2 btn-danger`}
                                                  onClick={() => setTopluSilmeModal(true)}
                                                >
                                                    {topluIds.length > 1 ? 'Toplu Sil' : 'Sil'}
                                                </button>
                                            </div>
                                          ) : null}
                                          <button
                                            className="btn text-nowrap btn-default fs13 form-control w40 mt-2 mr-2"
                                            onClick={() =>
                                              kayitModal ? kayitModalKapat() : setKayitModal(true)
                                            }
                                          >
                                              {kayitModal ? "Kayıt Kapat" : "Kayıt Ekle"}
                                          </button>
                                      </div>
                                      {topluSilmeModal ? (
                                        // @ts-ignore
                                        <SweetAlert
                                          danger
                                          showCancel
                                          title='Emin misiniz?'
                                          confirmBtnText='Evet, sil!'
                                          cancelBtnText='Hayır, silme'
                                          onConfirm={() => topluSil()}
                                          onCancel={() => setTopluSilmeModal(false)}
                                          confirmBtnBsStyle='danger fs14'
                                          cancelBtnBsStyle='fs14'
                                        >
                                            Kayıtları silmeniz durumunda ilgili kaydı tekrar girmek zorunda kalırsınız.
                                        </SweetAlert>
                                      ) : null}
                                  </div>
                              </div>
                          </div>
                      </div>


                      <div className="col-12">
                          <form onSubmit={submitTabloData}>
                              {kayitModal ? (
                                <div className="card mt-4">
                                    <div className="card-body">
                                        <div className="row ">


                                            <div className="col-md-2">
                                                <div className="form-group">
                                                    <label className="whiteSpaceNowrap">
                                                        Kategori
                                                    </label>
                                                    <select
                                                      required
                                                      disabled={ editModal }
                                                      className="form-control p-1 fs13"
                                                      name="kategori"
                                                      value={editModal ? rowData.kategori : yeniTabloData.kategori}
                                                      onChange={handleYeniTabloData}>
                                                        <option value="">Seçiniz</option>
                                                        <option value="Düzeltme">Düzeltme</option>
                                                        <option value="Geliştirme">Geliştirme</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div className="col-md-2">
                                                <div className="fomr-group">
                                                    <label htmlFor="adminUsers">Sorumlu</label>
                                                    <select
                                                        className="form-control p-1 fs13"
                                                        name="sorumlu_id"
                                                        value={editModal ? rowData.sorumlu_id : ''}
                                                        onChange={handleYeniTabloData}>
                                                        <option value="">Seçiniz</option>
                                                        { adminUsers.length ? adminUsers.map((user, key)=> <option value={user.id} key={key}>{ user.name } {user.surname}</option>):null }
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="col-md-2">
                                                <div className="form-group">
                                                    <label className="whiteSpaceNowrap">
                                                        Modül
                                                    </label>
                                                    <input
                                                      type="text"
                                                      name="modul"
                                                      className="form-control p-1 fs13 text-center"
                                                      disabled={editModal ? true : null}
                                                      value={editModal ? rowData.modul : yeniTabloData.modul}
                                                      onChange={handleYeniTabloData}
                                                    />
                                                </div>
                                            </div>


                                            <div className="col-md-2">
                                                <div className="form-group">
                                                    <label className="whiteSpaceNowrap">
                                                        Öncelik
                                                    </label>
                                                    <select
                                                      className="form-control p-1 fs13"
                                                      name="oncelik_durum"
                                                      disabled={editModal ? true : null}
                                                      value={editModal ? rowData.oncelik_durum : yeniTabloData.oncelik_durum}
                                                      onChange={handleYeniTabloData}>
                                                        <option value="">Seçiniz</option>
                                                        <option value="Düşük">Düşük</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Yüksek">Yüksek</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="col-md-2">
                                                <div className="form-group">
                                                    <label className="whiteSpaceNowrap">
                                                        Ekran
                                                    </label>
                                                    <input
                                                      type="text"
                                                      name="ekran"
                                                      className="form-control p-1 fs13 text-center"
                                                      disabled={editModal ? true : null}
                                                      value={editModal ? rowData.ekran : yeniTabloData.ekran}
                                                      onChange={handleYeniTabloData}
                                                    />
                                                </div>
                                            </div>

                                            <div className="col-md-4">
                                                <div className="form-group">
                                                    <label className="whiteSpaceNowrap">
                                                        Açıklama
                                                    </label>
                                                    <input
                                                      type="text"
                                                      name="aciklama"
                                                      className="form-control p-1 fs13 text-center"
                                                      disabled={editModal ? true : null}
                                                      value={editModal ? rowData.aciklama : yeniTabloData.aciklama}
                                                      onChange={handleYeniTabloData}

                                                    />
                                                </div>
                                            </div>
                                            
                                            <div className="col-md-4">
                                                <div className="form-group">
                                                    <label className="whiteSpaceNowrap">
                                                        Belge/Fotoğraf
                                                    </label>
                                                    <div className="custom-file">
                                                        <input type="file" className="custom-file-input" onChange={ ( e ) => onFileChange ( e ) }/>
                                                        <label className="custom-file-label" htmlFor="exampleInputFile">Belge/Fotoğraf Yükleyin</label>
                                                    </div>
                                                </div>
                                            </div>
                                            {editModal ?
                                              <div className="col-md-2">
                                                  <div className="form-group">
                                                      <label className="whiteSpaceNowrap">
                                                          Statü
                                                      </label>
                                                      <select
                                                        className="form-control p-1 fs13"
                                                        name="statu"
                                                        value={editModal ? rowData.statu : ''}
                                                        onChange={handleYeniTabloData}>
                                                          <option value="">Seçiniz</option>
                                                          <option value="Bekliyor">Bekliyor</option>
                                                          <option value="İşleme Alındı">İşleme Alındı</option>
                                                          <option value='Tamamlandı'>Tamamlandı</option>
                                                          <option value="İptal">İptal</option>
                                                      </select>
                                                  </div>
                                              </div>
                                              : ""}
                                            {editModal ?
                                              <div className="col-md-10">
                                                  <div className="form-group">
                                                      <label className="whiteSpaceNowrap">
                                                          Sistem Yanıtı
                                                      </label>
                                                      <input
                                                        type="text"
                                                        name="sistem_yanit"
                                                        className="form-control p-1 fs13 text-center"
                                                        value={editModal && rowData.sistem_yanit == null  ? ''  : rowData.sistem_yanit}
                                                        onChange={handleYeniTabloData}
                                                      />
                                                  </div>
                                              </div> : ""}
    
                                            <div className="col-12">
                                                <div className="row">
                                                    { fileList.map((item,key)=>
                                                        <div className="col-md-3 imgFileContainer" key={key}>
                                                            {typeof item === 'string' ? ( isImage(item) ? (
                                                                    <div className="imgContainer">
                                                                        <a href={api_url + item} rel="noreferrer" target="_blank" download>
                                                                            <img src={api_url + item}/>
                                                                        </a>
                                                                    </div>
                                                                ) : (
                                                                    <div className="fileContainer">
                                                                        <a href={api_url + item} rel="noreferrer" target="_blank" download>
                                                                            <FontAwesomeIcon icon={ faFile } style={{width:"100%", height:"100%"}} />
                                                                            <span>{getName(item)}</span>
                                                                        </a>
                                                                    </div>
                                                                )
                                                            ) : ( item.type.indexOf('image/') > -1 ? (
                                                                <div className="imgContainer">
                                                                    <a href={URL.createObjectURL(item)} rel="noreferrer" target="_blank" download>
                                                                        <img src={URL.createObjectURL(item)}/>
                                                                    </a>
                                                                </div>
                                                            ) : (
                                                                <div className="fileContainer">
                                                                    <a href={URL.createObjectURL(item)} rel="noreferrer" target="_blank" download>
                                                                        <FontAwesomeIcon icon={ faFile } style={{width:"100%", height:"100%"}} />
                                                                        <span>{item.name}</span>
                                                                    </a>
                                                                </div>
                                                            )
                                                            )}
                                                        </div>
                                                    ) }
                                                </div>
                                            </div>


                                            <div className="col-12 text-right">
                                                <button
                                                  className="btn btn-default fs13"
                                                  onClick={kayitModalKapat}
                                                >
                                                    Kapat
                                                </button>
                                                &nbsp;
                                                <button
                                                  type="submit"
                                                  className="btn btn-primary fs13"
                                                >
                                                    Kaydet
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                              ) : null}
                          </form>
                      </div>

                      <div className="container-fluid">
                          <div className="row">
                              <div className="col-12">
                                  <div className="card">
                                      <div className={`card-body p-0 custom-scrollbar position-relative  ${isMobile ? "overflow-auto" : " "}`} style={{overflowX:"scroll",height:"70vh"}}>
                                          <table className="table table-bordered table-striped border-2 border-secondary headerAnchor">
                                              <thead>
                                              <tr>
                                                  {
                                                      userService.hasYetki("destek_talep.talep_olustur.action.edit") ?
                                                        <th className='text-center text-nowrap px-3' style={{backgroundColor: '#e9f5fd'}}>
                                                            <input type='checkbox' onChange={(e) => selectAllCheckbox(e)} />
                                                        </th> : null
                                                  }
                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      ID
                                                  </th>
                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Talep Tarihi
                                                  </th>

                                                  <th style={{ width: "100px", backgroundColor: '#e9f5fd'}} className="text-nowrap text-center p-2">
                                                      Statü
                                                  </th>
                                                  <th  className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Öncelik
                                                  </th>

                                                  <th style={{ width: "115px", backgroundColor: '#e9f5fd'}} className="text-nowrap text-center p-2">
                                                      Ekleyen
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Kategori
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Modül
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Ekran
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Açıklama
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Sorumlu
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Sistem Yanıt
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      Tamamlanma Tarihi
                                                  </th>

                                                  <th className="text-nowrap text-center p-2" style={{backgroundColor: '#e9f5fd'}}>
                                                      İndir
                                                  </th>
                                                  
                                                  { userService.hasYetki("destek_talep.talep_olustur.action.decline") ?
                                                    <th className="text-center" style={{backgroundColor: '#e9f5fd',color:"red"}}>İptal Et</th>
                                                    : null }

                                                  { userService.hasYetki("destek_talep.talep_olustur.action.edit") ?
                                                    <th className="p-2  text-center" style={{backgroundColor: '#e9f5fd'}}><i className="fas fa-pen"></i></th>
                                                    : null }
                                              </tr>
                                              </thead>
                                              <tbody>
                                              {tabloData.status ? tabloData.data.map((item, key) =>
                                                <tr key={key}>
                                                    {
                                                        userService.hasYetki("destek_talep.talep_olustur.action.edit") ?
                                                          <td className='anchor text-center align-middle '>
                                                              <input type='checkbox' onChange={(e) => addTopluId(e, `${item.id}`)} checked={topluIds.includes(`${item.id}`)} />
                                                          </td> : null
                                                    }
                                                    <td data-type="id"
                                                        className="anchor align-middle text-center">{ item.id }</td>

                                                    <td data-type="talep_tarihi"
                                                        className="anchor align-middle text-center">{ item.talep_tarihi.dateFormat('DD/MM/YYYY') }</td>

                                                    <td data-type="statu" style={{ backgroundColor: statuBg[item.statu], color: statuColor[item.statu], width: "100px" }}
                                                        className="anchor align-middle text-left">{ item.statu }</td>

                                                    <td data-type="oncelik_durum"
                                                        className="anchor align-middle text-left">{ item.oncelik_durum }</td>

                                                    <td data-type="ekleyen" style={{ width: "115px" }}
                                                        className="anchor align-middle text-left">{ item.ekleyen }</td>

                                                    <td data-type="kategori"
                                                        className="anchor align-middle text-left">{ item.kategori }</td>

                                                    <td data-type="modul"
                                                        className="anchor align-middle text-left">{ item.modul }</td>

                                                    <td data-type="ekran"
                                                        className="anchor align-middle text-left">{ item.ekran }</td>

                                                    <td data-type="aciklama"
                                                        className="anchor align-middle text-left">{ item.aciklama }</td>

                                                    <td data-type="sorumlu_name"
                                                        className="anchor align-middle text-left">{ item.sorumlu_name }</td>

                                                    <td data-type="sistem_yanit"
                                                        className="anchor align-middle text-left">{ item.sistem_yanit }</td>

                                                    <td data-type="tamamlanma_tarihi"
                                                        className="anchor align-middle text-center">{ item.tamamlanma_tarihi != null ? item.tamamlanma_tarihi.dateFormat('DD/MM/YYYY') : "" }</td>

                                                    <td data-type="tamamlanma_tarihi" className="anchor align-middle text-center">
                                                        {item.resimler.length ? <span className="badge border border-primary text-primary font-weight-normal fs12 anchor ml-1" onClick={()=>downloadFileAll(item.resimler)}>İndir<i className="fas fa-arrow-down ml-1 fs12"></i></span> : null }
                                                    </td>

                                                    { userService.hasYetki("destek_talep.talep_olustur.action.decline") ?
                                                      <td data-type="aksiyon"
                                                          className="anchor text-center align-middle ">
                                                          {item.statu != 'İptal' && item.statu != "Tamamlandı" ?
                                                            <span
                                                              className="badge border border-danger text-danger font-weight-normal fs12 anchor m-1"
                                                              onClick={() => setSilmeModal(item.id)}>İptal Et</span>

                                                            : null }



                                                          {/*@ts-ignore*/}
                                                          {silmeModal === item.id ? <SweetAlert
                                                            danger
                                                            showCancel
                                                            title="Emin misiniz?"
                                                            confirmBtnText="Evet, İptal Et!"
                                                            cancelBtnText="Hayır"
                                                            onConfirm={() => kayitSil(item.id)}
                                                            onCancel={() => setSilmeModal(null)}
                                                            confirmBtnBsStyle="danger"
                                                          >
                                                              Destek Talebi Statüsü İptal olarak değiştirilecektir.
                                                          </SweetAlert> : null}
                                                      </td>
                                                      : null }

                                                    { userService.hasYetki("destek_talep.talep_olustur.action.edit") ?
                                                      <td className="anchor  align-middle text-center">

                                                            <span
                                                              className="badge border border-info text-info anchor fs12 font-weight-normal m-1"
                                                              onClick={() => updateOpenModal(item)}>Güncelle</span>
                                                      </td>
                                                      : null }

                                                </tr>) : (<tr>
                                                  <td colSpan={13} className="text-center  align-middle">Data
                                                      bulunmamaktadır
                                                  </td>
                                              </tr>)}
                                              </tbody>
                                          </table>
                                      </div>
                                  </div>
                                  <RPagination
                                    onPageChange={(event) => setPage(event.selected + 1)}
                                    pageRangeDisplayed={ isMobile ? 2 : 4 }
                                    marginPagesDisplayed={ isMobile ? 1 : 5 }
                                    pageCount={tabloData.totalPages}
                                  />
                              </div>
                          </div>
                      </div>

                  </div>
              </div>
              <ScrollToTop />
          </div>
        ) : <Loader />}
    </div>;
};

export async function getStaticProps(context: NextPageContext){
    return getStaticPropsHandler(context);
}

export default DestekTalep;
